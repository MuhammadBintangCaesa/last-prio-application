<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
      <link rel="icon" type="image/png" href="image/prio.back.png">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .completed { text-decoration: line-through; opacity: 0.6; }
        .priority-badge { font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 9999px; }
        .priority-high { background-color: #FECACA; color: #991B1B; }
        .priority-medium { background-color: #FEF3C7; color: #92400E; }
        .priority-low { background-color: #D1FAE5; color: #065F46; }

        #app-container {
            position: relative;
            z-index: 1;
            max-width: 900px;
            margin: 0 auto;
            padding: 2rem 1rem 6rem;
        }

        @media (min-width: 720px) {
            .cube-container .container {
                width: 100%;
            }
        }

        body {
            background-color: #000 !important;
            position: relative; 
            inset: 0;
            display: block; 
            min-height: 100vh;
            overflow-y: auto; 
        }

        #main-content {
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(12px);
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.07);
    padding-top: 2rem;
    padding-bottom: 2rem;
}

        /* Animasi Kubus */
        .cube-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }
        .cube-container .container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-35deg);
            width: 100%;
        }
        .cube-container .container .box {
            position: relative;
            left: -100px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: calc(100% + 400px);
            -webkit-box-reflect: below 1px linear-gradient(transparent, #000);
            animation: animatesurface 1.5s ease-in-out infinite;
        }
        @keyframes animatesurface {
            0% {
                transform: translateX(0);
            }
            100% {
                transform: translateX(-200px);
            }
        }
        .cube-container .container .box .cube {
            position: relative;
            width: 200px;
            height: 200px;
            background: #03e9f4;
            box-shadow: 0 0 5px rgba(3,233,244,1),
                        0 0 25px rgba(3,233,244,1),
                        0 0 50px rgba(3,233,244,1),
                        0 0 150px rgba(3,233,244,1);
            transform-origin: bottom right;
            animation: animate 1.5s ease-in-out infinite;
        }
        @keyframes animate {
            0% { 
                transform: rotate(0deg);
            }
            60%, 70%, 80%, 100% {
                transform: rotate(90deg);
            }
            65% {
                transform: rotate(85deg);
            }
            75% {
                transform: rotate(87.5deg);
            }
        }
        /* Navbar */
        .navbar {
            width: 100%;
            background: rgba(0,0,0,0.1);
            padding: 20px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            position: relative;
        }
        .navbar a {
            color: #fff;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 20px;
            transition: all 0.3s;
        }
        .navbar a:hover {
            background: rgba(255,255,255,0.1);
            color: #03e9f4;
            transform: translateY(-2px);
        }
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        .modal.show {
            display: flex;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            text-align: center;
        }
        .tutorial-modal .modal-content {
            max-width: 90vw !important;
        }
        .modal-content h2 {
            margin-bottom: 20px;
        }
        .modal-content p {
            margin-bottom: 20px;
        }
        .modal-content textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        .modal-content button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            background: #03e9f4;
            color: #000;
            cursor: pointer;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        #reviews-container {
            transition: transform 1s ease;
        }

    </style>
</head>
<body class="text-slate-800">
    <div class="cube-container">
        <div class="container">
            <div class="box">
                <div class="cube"></div>
            </div>
        </div>
    </div>
    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <nav class="navbar">
            <div class="flex items-center gap-4">
                <img src="image/prio.back-removebg-preview.png" alt="logo" class="h-16">
                <span class="text-2xl font-bold text-white">MyPrio</span>
            </div>
            <!-- Hamburger Menu Button for Mobile -->
            <button id="mobile-menu-button" class="md:hidden text-white focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
            <!-- Desktop Menu -->
            <div class="hidden md:flex gap-4">
                <a href="#" id="about-link">Tentang Kami</a>
                <a href="#" id="review-link">Review Web</a>
                <a href="#" id="tutorial-link">Tutorial</a>
            </div>
            <!-- Mobile Menu -->
            <div id="mobile-menu" class="md:hidden absolute top-full left-0 w-full bg-black/90 backdrop-blur-lg border-t border-white/20 hidden flex-col gap-4 p-4">
                <a href="#" id="about-link-mobile" class="text-white text-center py-2">Tentang Kami</a>
                <a href="#" id="review-link-mobile" class="text-white text-center py-2">Review Web</a>
                <a href="#" id="tutorial-link-mobile" class="text-white text-center py-2">Tutorial</a>
            </div>
        </nav>

        <br>
        <header id= "header" class="mb-8 text-center text-white">
            <p class="text-lg text-slate-300">Bantu kamu mengelola dan memprioritaskan tugas dengan cerdas</p>
        </header>
        
        <!-- Elemen UI untuk Login dan Logout -->
       <!-- LOGIN VIEW -->
        <div id="login-view" class="flex items-center justify-center py-12">
            <div class="bg-white/40 backdrop-blur-lg border border-white/20 rounded-2xl p-8 shadow-lg w-full sm:w-[420px] text-center transition-all duration-500 hover:scale-[1.02]">
            <h2 class="text-2xl font-bold text-white mb-2">
            Selamat Datang di <span class="text-blue-300">Prio</span>
            </h2>
            <p class="text-slate-300 mb-6 text-sm">
            Kelola & prioritaskan tugasmu dengan cerdas
            </p>
            <div class="flex flex-col gap-4">
            <button id="login-button" class="bg-white text-slate-700 font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg hover:bg-slate-100 transition-all flex items-center justify-center gap-2 w-full">
                <img src="https://www.svgrepo.com/show/355037/google.svg" alt="Google" class="w-5 h-5">
                Login dengan Google
            </button>
            <button id="guest-login-button" class="bg-gradient-to-r from-blue-600 to-indigo-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:from-blue-700 hover:to-indigo-600 transition-all w-full">
                Masuk sebagai Tamu!
            </button>
            </div>
            <p class="text-xs text-slate-400 mt-6">
            Dengan login, Anda menyetujui
            <button id="privacy-btn" class="text-blue-300 hover:underline">kebijakan privasi</button>.
            </p>
        </div>
        </div>


            <!-- MODAL KEBIJAKAN PRIVASI -->
            <div id="privacy-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm">
                <div class="bg-white/90 rounded-xl shadow-xl w-[90%] sm:w-[420px] p-6 text-slate-700 relative">
                    <h3 class="text-xl font-bold mb-3 text-center">Kebijakan Privasi</h3>
                    <p class="text-sm text-slate-600 leading-relaxed mb-4">
                        Kami menghormati privasi Anda. Data akun Google Anda hanya digunakan untuk otentikasi login
                        dan tidak akan dibagikan kepada pihak ketiga tanpa izin Anda.
                    </p>
                    <ul class="list-disc list-inside text-sm text-slate-600 mb-4 text-left">
                        <li>Informasi pribadi tidak disimpan secara permanen di server.</li>
                        <li>Cookie hanya digunakan untuk menjaga sesi login.</li>
                        <li>Anda dapat menghapus data login kapan saja melalui tombol Logout.</li>
                    </ul>
                    <button id="close-privacy" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition-all w-full">
                        Tutup
                    </button>
                </div>
            </div>

            <!-- Tampilan Setelah Login -->
            <div id="user-view" class="hidden text-center mt-6">
                <p class="text-sm text-slate-300 mb-3">Login sebagai <strong id="user-email" class="text-white"></strong></p>
                <button id="logout-button" class="bg-red-500 text-white font-semibold py-1.5 px-5 text-sm rounded-lg hover:bg-red-600 transition-all shadow-md">Logout</button>
            </div>
        </div>

        <!-- Konten Utama -->
    <main id="main-content" class="hidden min-h-screen bg-transparent py-10 px-4 max-w-6xl mx-auto">
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4">Tambah Tugas (Manual)</h2>
                <!-- Form input -->
                <form id="task-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 1">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 2">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 3">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 4">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 5">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 6">
                    <div><label for="task-urgency" class="block text-sm font-medium text-slate-700 mb-1">Urgensi (1-5)</label><input type="range" id="task-urgency" min="1" max="5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"><span id="urgency-value" class="text-sm text-slate-500">3 (Sedang)</span></div>
                    <div><label for="task-importance" class="block text-sm font-medium text-slate-700 mb-1">Pentingnya (1-5)</label><input type="range" id="task-importance" min="1" max="5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"><span id="importance-value" class="text-sm text-slate-500">3 (Cukup Penting)</span></div>
                    <div class="md:col-span-2"><label for="task-deadline" class="block text-sm font-medium text-slate-700 mb-1">Deadline Tugas (Tanggal)</label><input type="date" id="task-deadline" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div class="md:col-span-2"><label for="task-time" class="block text-sm font-medium text-slate-700 mb-1">Estimasi Waktu (Jam)</label><input type="number" id="task-time" min="0.5" step="0.5" value="1" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">Prioritaskan & Tambah</button></div>
                </form>
            </div>

            <div>
                <!-- Daftar Tugas & Tombol Download Baru -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-white">Daftar Tugas Anda (Diurutkan)</h2>
                    <!-- Tombol Download HANYA UNTUK GOOGLE USER -->
                    <button id="download-my-data-button" class="hidden bg-green-600 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download Dataku
                    </button>
                </div>

                <!-- Panel Admin DIHAPUS -->

                <div id="task-list" class="space-y-4">
                    <p id="loading-tasks" class="text-slate-300 text-center">Memuat tugas...</p>
                </div>
            </div>
        </main>
    </div>
</body>
</html>


    <div id="about-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-about">&times;</span>
            <h2>Tentang Kami</h2>
            <p>Kami adalah mahasiswa dari Universitas Gunadarma yang mengembangkan aplikasi Prio untuk membantu mahasiswa dalam memprioritaskan tugas kuliah dengan cerdas.</p>
            <button id="close-about-button">Tutup</button>
        </div>
    </div>

    <div id="review-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="close-review">&times;</span>
            <h2>Berikan Review Web Kita</h2>
            <input type="text" placeholder="Nama Anda" id="review-name" class="w-full px-3 py-2 border border-slate-300 rounded-lg mb-4"><br>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">Rating:</label>
                <div class="stars flex text-2xl">
                    <span class="star cursor-pointer text-gray-400" data-rating="1">â˜…</span>
                    <span class="star cursor-pointer text-gray-400" data-rating="2">â˜…</span>
                    <span class="star cursor-pointer text-gray-400" data-rating="3">â˜…</span>
                    <span class="star cursor-pointer text-gray-400" data-rating="4">â˜…</span>
                    <span class="star cursor-pointer text-gray-400" data-rating="5">â˜…</span>
                </div>
            </div>
            <textarea placeholder="Tulis review Anda di sini..." class="w-full px-3 py-2 border border-slate-300 rounded-lg mb-4"></textarea><br>
            <button id="submit-review">Kirim Review</button>
            <button id="close-review-button">Tutup</button>
        </div>
    </div>

    <div id="tutorial-modal" class="modal tutorial-modal">
        <div class="modal-content">
            <span class="close-btn" id="close-tutorial">&times;</span>
            <h2>Tutorial Penggunaan</h2>
            <div class="mt-6 rounded-xl overflow-hidden border border-white/20 shadow-inner">
                <iframe 
                    class="w-full aspect-video rounded-xl"
                    src="https://www.youtube.com/embed/yBLAbgD-AlU"
                    title="Video intro"
                    allow="accelerometer; autoplay=0; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>
            <button id="close-tutorial-button">Tutup</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, deleteDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Fungsi utilitas aman ---
        function safeAddEventListener(elementId, event, handler) {
             try {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener(event, handler);
                } else {
                    console.warn(`[WARN] Elemen dengan ID "${elementId}" tidak ditemukan saat mencoba menambah listener.`);
                }
            } catch(e) {
                 console.error(`[ERROR] Gagal menambah listener ke #${elementId}:`, e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("[DEBUG] Halaman HTML selesai dimuat. Memulai skrip.");

            let selectedRating = 0;

            // Konfigurasi Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyC4WwUhxG5XROTr5lSHvhDS4zj2Lqmw1U0",
                authDomain: "asisten-tugas-pribadi.firebaseapp.com",
                projectId: "asisten-tugas-pribadi",
                storageBucket: "asisten-tugas-pribadi.appspot.com",
                messagingSenderId: "994319187177",
                appId: "1:994319187177:web:58ebbc1fce8645eabd4478"
            };

            let db, auth, userId, unsubscribeTasks;
            const appId = 'asisten-tugas-pribadi';
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("[DEBUG] Firebase diinisialisasi.");

            // --- Fungsi Review ---
            function listenToReviews() {
                const reviewsRef = collection(db, `artifacts/${appId}/reviews`);
                onSnapshot(reviewsRef, (snapshot) => {
                    const reviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderReviews(reviews);
                });
            }

            // --- Elemen UI ---
            const loginView = document.getElementById('login-view');
            const userView = document.getElementById('user-view');
            const mainContent = document.getElementById('main-content');
            const userEmailSpan = document.getElementById('user-email');
            const taskForm = document.getElementById('task-form');
            const taskListDiv = document.getElementById('task-list');
            const downloadMyDataButton = document.getElementById('download-my-data-button'); // Tombol download baru
            
            // --- Fungsi Admin Dihapus ---
            // const loadUserListForAdmin = ... (DIHAPUS)
            // const checkAdminStatus = ... (DIHAPUS)

            // --- onAuthStateChanged (Disederhanakan) ---
            onAuthStateChanged(auth, async (user) => {
                // Sembunyikan semua elemen dinamis di awal
                mainContent.classList.add('hidden');
                userView.classList.add('hidden');
                loginView.classList.add('hidden');
                downloadMyDataButton.classList.add('hidden'); 

                if (user) {
                    userId = user.uid;
                    userEmailSpan.innerHTML = user.isAnonymous ? `Tamu <span class="font-normal text-slate-400 text-xs">(${user.uid.substring(0, 6)}...)</span>` : user.email;
                    
                    userView.classList.remove('hidden');
                    mainContent.classList.remove('hidden');

                    // Tampilkan tombol download HANYA jika bukan tamu
                    if (!user.isAnonymous) {
                        downloadMyDataButton.classList.remove('hidden');
                    }

                    listenToTasks();
                } else {
                    userId = null;
                    loginView.classList.remove('hidden'); // Tampilkan view login
                    if (unsubscribeTasks) unsubscribeTasks();
                    renderTasks([]);
                }
            });

            listenToReviews();

            // --- Path Collection ---
            const getTasksCollectionRef = (targetUserId) => {
                const idToUse = targetUserId || userId;
                if (!idToUse) {
                    console.error("[DEBUG] GAGAL: getTasksCollectionRef dipanggil tetapi ID pengguna adalah null!");
                    return null;
                }
                return collection(db, `artifacts/${appId}/users/${idToUse}/tasks`);
            }

            // --- FUNGSI ADD NEW TASK (YANG HILANG) ---
            const addNewTask = async (taskData) => {
                 if (!userId) {
                     alert("Error: Anda tidak terautentikasi.");
                     return false;
                 }
                 try {
                     const urgency = Number(taskData.urgency);
                     const importance = Number(taskData.importance); // Menggunakan importance
                     const time = Number(taskData.time);

                     if (isNaN(urgency) || isNaN(importance) || isNaN(time)) {
                         throw new Error("Data input tidak valid. Gagal menghitung skor.");
                     }
                     
                     const priorityScore = parseFloat(((urgency * 3.5) + (importance * 2.5) - (time * 0.5)).toFixed(2));
                     
                     const fullTaskData = {
                         name: taskData.name,
                         urgency: urgency,
                         importance: importance, // Menggunakan importance
                         time: time,
                         deadline: taskData.deadline, // Menambahkan deadline
                         priorityScore: priorityScore,
                         status: 'pending',
                         createdAt: serverTimestamp()
                     };

                     const collectionRef = getTasksCollectionRef(userId);
                     if (!collectionRef) throw new Error("Referensi koleksi tidak valid (userId null).");
                     
                     await addDoc(collectionRef, fullTaskData);
                     return true;
                 } catch (error) {
                     console.error("GAGAL MENAMBAHKAN TUGAS:", error);
                     alert("GAGAL: " + error.message);
                     return false;
                 }
             };

taskForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) {
        alert("Error: Anda tidak terautentikasi.");
        return;
    }

    const taskInputs = document.querySelectorAll('.task-name');
    const urgency = parseInt(document.getElementById('task-urgency').value);
    const importance = parseInt(document.getElementById('task-importance').value);
    const time = parseFloat(document.getElementById('task-time').value);
    const deadlineValue = document.getElementById('task-deadline').value;

    const deadlineDate = deadlineValue ? new Date(deadlineValue) : null;
    if (deadlineDate) deadlineDate.setHours(23, 59, 59);

    let hasTask = false;

    // Loop semua input nama tugas
    for (const input of taskInputs) {
        const name = input.value.trim();
        if (name === "") continue;

        hasTask = true;

        const taskData = {
            name,
            urgency,
            importance,
            time,
            deadline: deadlineDate || null
        };

        await addNewTask(taskData);
    }

    if (!hasTask) {
        alert("Minimal isi 1 tugas.");
        return;
    }

    // Reset form
    e.target.reset();
    document.getElementById('urgency-value').textContent = '3 (Sedang)';
    document.getElementById('importance-value').textContent = '3 (Cukup Penting)';
});


            // --- Login/Logout ---
            const signInWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(err => console.error(err));
            const signInAsGuest = () => signInAnonymously(auth).catch(err => console.error(err));
            const doSignOut = () => signOut(auth).catch(err => console.error(err));
            safeAddEventListener('login-button', 'click', signInWithGoogle);
            safeAddEventListener('guest-login-button', 'click', signInAsGuest);
            safeAddEventListener('logout-button', 'click', doSignOut);

            // --- FUNGSI EKSPOR CSV FIX (NON-ADMIN) ---
const exportMyDataAsCsv = async () => {
    if (!userId) {
        alert("Silakan login terlebih dahulu.");
        return;
    }

    try {
        const tasksCollectionRef = getTasksCollectionRef(userId);
        const tasksSnapshot = await getDocs(query(tasksCollectionRef));

        const tasks = [];
        tasksSnapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));

        if (tasks.length === 0) {
            alert("Anda tidak memiliki data tugas.");
            return;
        }

        // --- ðŸ”¥ SORT BIAR SESUAI UI (priorityScore terbesar â†’ terkecil)
        tasks.sort((a, b) => (b.priorityScore ?? 0) - (a.priorityScore ?? 0));

        // --- Fungsi escape agar koma tidak rusak CSV
        const escapeCSV = value => {
            if (value == null) return "";
            const str = String(value);
            return (str.includes(",") || str.includes('"')) 
                ? `"${str.replace(/"/g, '""')}"`
                : str;
        };

        // --- Header CSV
        const headers = [
            "ID Tugas",
            "Nama Tugas",
            "Urgensi",
            "Pentingnya",
            "Estimasi Waktu",
            "Deadline",
            "Skor Prioritas",
            "Status",
            "Dibuat"
        ];

        // --- Buat baris data
        const rows = tasks.map(task => {
            const deadline = task.deadline
                ? new Date(task.deadline.seconds * 1000).toLocaleDateString("id-ID")
                : "N/A";

            const createdAt = task.createdAt
                ? new Date(task.createdAt.seconds * 1000).toLocaleString("id-ID")
                : "N/A";

            return [
                escapeCSV(task.id),
                escapeCSV(task.name),
                escapeCSV(task.urgency),
                escapeCSV(task.importance),
                escapeCSV(task.time),
                escapeCSV(deadline),
                escapeCSV(task.priorityScore),
                escapeCSV(task.status),
                escapeCSV(createdAt)
            ].join(",");
        });

        // Gabungkan CSV
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);

        const date = new Date().toISOString().slice(0, 10);
        link.download = `prio_data_saya_${date}.csv`;

        link.click();
        URL.revokeObjectURL(link.href);

    } catch (error) {
        console.error("[DEBUG] CSV Export Error:", error);
        alert("Gagal mengunduh data.");
    }
};
            safeAddEventListener('download-my-data-button', 'click', exportMyDataAsCsv);
            // --- Baca & Tampilkan Data ---
            function listenToTasks() {
                if (!userId) return;
                if (unsubscribeTasks) unsubscribeTasks();
                const q = query(getTasksCollectionRef(userId));
                if (!q) return;
                unsubscribeTasks = onSnapshot(q, (snapshot) => {
                    let tasks = [];
                    snapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));
                    tasks.sort((a, b) => (b.priorityScore ?? -Infinity) - (a.priorityScore ?? -Infinity));
                    renderTasks(tasks);
                }, (error) => {
                    console.error("[DEBUG] Gagal mendengarkan data (listenToTasks):", error);
                });
            }

            function renderTasks(tasks) {
                const loadingP = document.getElementById('loading-tasks');
                if(loadingP) loadingP.style.display = 'none';

                if (tasks.length === 0) {
                    taskListDiv.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md"><h3 class="font-semibold text-lg">Tidak ada tugas!</h3><p class="text-slate-500 mt-1">Tambahkan tugas baru di atas untuk memulai.</p></div>`;
                    return;
                }

                taskListDiv.innerHTML = tasks.map(task => {
                    const priorityScoreNum = Number(task.priorityScore);
                    const priorityText = isNaN(priorityScoreNum) ? 'N/A' :
                                     priorityScoreNum > 15 ? 'Tinggi' :
                                     priorityScoreNum > 8 ? 'Sedang' : 'Rendah';
                    const priorityClass = isNaN(priorityScoreNum) ? 'priority-low' :
                                        priorityText === 'Tinggi' ? 'priority-high' :
                                        priorityText === 'Sedang' ? 'priority-medium' : 'priority-low';
                    const scoreDisplay = isNaN(priorityScoreNum) ? 'NaN' : priorityScoreNum.toFixed(1);
                    
                    // Format deadline untuk ditampilkan
                const deadlineText = task.deadline ? new Date(task.deadline).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}) : 'Tidak Ditentukan';

                    return `
                    <div class="task-card bg-white p-4 rounded-xl shadow-md flex items-start gap-4 ${task.status === 'completed' ? 'opacity-60' : ''}">
                        <input type="checkbox" onchange="window.toggleTaskStatus('${task.id}', '${task.status}')" class="mt-1.5 h-5 w-5 rounded" ${task.status === 'completed' ? 'checked' : ''}>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <p class="font-semibold text-lg ${task.status === 'completed' ? 'line-through' : ''}">${task.name}</p>
                                <span class="priority-badge ${priorityClass}">${priorityText} (${scoreDisplay})</span>
                            </div>
                            <div class="text-sm text-slate-500 mt-2 flex flex-col sm:flex-row sm:gap-4">
                                <span>Urgensi: <strong>${task.urgency}</strong></span>
                                <span>Pentingnya: <strong>${task.importance}</strong></span> <!-- Menggunakan importance -->
                                <span>Waktu: <strong>${task.time} jam</strong></span>
                            </div>
                             <div class="text-sm text-slate-700 mt-2 font-medium">
                                <span>Deadline: <strong>${deadlineText}</strong></span>
                            </div>
                        </div>
                        <button onclick="window.deleteTask('${task.id}')" class="text-slate-400 hover:text-red-500 p-1">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>`;
                }).join('');
            }

            // --- Fungsi Review ---
            function addReview(text, name, rating) {
                const reviewsRef = collection(db, `artifacts/${appId}/reviews`);
                addDoc(reviewsRef, {
                    name: name,
                    text: text,
                    date: new Date().toLocaleDateString('id-ID'),
                    rating: rating,
                    timestamp: serverTimestamp()
                });
            }

            function renderReviews(reviews) {
                const container = document.getElementById('reviews-container');
                if (reviews.length === 0) {
                    reviews = [
                        {name: 'Ahmad S.', text: 'Aplikasi ini sangat membantu saya dalam mengatur prioritas tugas kuliah. Interface-nya simpel dan mudah digunakan!', date: '27/11/2025', rating: 5},
                        {name: 'Budi R.', text: 'Fitur prioritas berdasarkan deadline dan tingkat kesulitan sangat akurat. Sudah tidak pernah telat submit tugas lagi!', date: '26/11/2025', rating: 5},
                        {name: 'Citra D.', text: 'Animasi kubus di background-nya keren! Membuat aplikasi terlihat lebih menarik dan tidak membosankan.', date: '25/11/2025', rating: 4}
                    ];
                }
                container.innerHTML = reviews.map(review => `
                    <div class="bg-white/10 backdrop-blur-lg border border-white/20 rounded-xl p-6 shadow-lg flex-shrink-0 w-80">
                        <div class="flex items-center mb-4">
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">${review.name[0]}</div>
                            <div class="ml-3">
                                <h3 class="text-white font-semibold">${review.name}</h3>
                                <p class="text-slate-300 text-sm">${review.date}</p>
                            </div>
                        </div>
                        <p class="text-slate-200">"${review.text}"</p>
                        <div class="flex text-yellow-400 mt-2">${'â˜…'.repeat(review.rating || 5)}</div>
                    </div>
                `).join('');
                if (reviews.length > 3) {
                    container.style.width = `${reviews.length * 320 + (reviews.length - 1) * 24}px`;
                    startScrolling(reviews);
                }
            }

            function startScrolling(reviews) {
                const container = document.getElementById('reviews-container');
                let position = 0;
                const step = 320 + 24; // w-80 + gap-6
                setInterval(() => {
                    position = (position + step) % ((reviews.length - 2) * step);
                    container.style.transform = `translateX(-${position}px)`;
                }, 4000);
            }

            // Slider
            const urgencySlider = document.getElementById('task-urgency');
            const importanceSlider = document.getElementById('task-importance');
            const urgencyValue = document.getElementById('urgency-value');
            const importanceValue = document.getElementById('importance-value');
            const urgencyLabels = { 1: 'Sangat Rendah', 2: 'Rendah', 3: 'Sedang', 4: 'Mendesak', 5: 'Sangat Mendesak' };
            const importanceLabels = { 1: 'Tidak Penting', 2: 'Kurang Penting', 3: 'Cukup Penting', 4: 'Penting', 5: 'Sangat Penting' };
            urgencySlider.addEventListener('input', () => { urgencyValue.textContent = `${urgencySlider.value} (${urgencyLabels[urgencySlider.value]})`; });
            importanceSlider.addEventListener('input', () => { importanceValue.textContent = `${importanceSlider.value} (${importanceLabels[importanceSlider.value]})`; });

            // --- Fungsi Global (onclick) ---
            window.toggleTaskStatus = async (taskId, currentStatus) => {
                if (!userId) return;
                const newStatus = currentStatus === 'pending' ? 'completed' : 'pending';
                const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);
                await updateDoc(taskDocRef, { status: newStatus });
            };

            window.deleteTask = async (taskId) => {
                if (!userId) return;
                if (confirm('Yakin ingin menghapus tugas ini?')) {
                    const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);
                    await deleteDoc(taskDocRef);
                }
            };

            // --- Logika Modal Privasi & Gradient (Dipindah ke dalam) ---
            safeAddEventListener("privacy-btn", "click", () => {
                const privacyModal = document.getElementById("privacy-modal");
                if (privacyModal) privacyModal.classList.remove("hidden");
            });

            safeAddEventListener("close-privacy", "click", () => {
                const privacyModal = document.getElementById("privacy-modal");
                if (privacyModal) privacyModal.classList.add("hidden");
            });

            safeAddEventListener("privacy-modal", "click", (e) => {
                if (e.target.id === "privacy-modal") {
                    e.target.classList.add("hidden");
                }
            });
            
            safeAddEventListener("theme-toggle", "click", () => {
             document.documentElement.classList.toggle("dark");

            // simpan preferensi user
            if (document.documentElement.classList.contains("dark")) {
                localStorage.setItem("theme", "dark");
            } else {
                localStorage.setItem("theme", "light");
            }
        });

            // load preferensi saat halaman buka
            if (localStorage.getItem("theme") === "dark") {
                document.documentElement.classList.add("dark");
            }

            safeAddEventListener('about-link', 'click', (e) => {
                e.preventDefault();
                console.log('About link clicked');
                const modal = document.getElementById('about-modal');
                if (modal) {
                    modal.classList.add('show');
                    console.log('Modal shown');
                } else {
                    console.error('About modal not found');
                }
            });
            safeAddEventListener('review-link', 'click', (e) => {
                e.preventDefault();
                console.log('Review link clicked');
                const modal = document.getElementById('review-modal');
                if (modal) {
                    modal.classList.add('show');
                    console.log('Modal shown');
                } else {
                    console.error('Review modal not found');
                }
            });
            safeAddEventListener('close-about', 'click', () => {
                document.getElementById('about-modal').classList.remove('show');
            });
            safeAddEventListener('close-about-button', 'click', () => {
                document.getElementById('about-modal').classList.remove('show');
            });
            safeAddEventListener('close-review', 'click', () => {
                document.getElementById('review-modal').classList.remove('show');
            });
            safeAddEventListener('submit-review', 'click', () => {
                const nameInput = document.querySelector('#review-modal #review-name');
                const textarea = document.querySelector('#review-modal textarea');
                const reviewText = textarea.value.trim();
                const nameText = nameInput.value.trim() || 'Anonim';
                if (!selectedRating) {
                    alert('Pilih rating dulu.');
                    return;
                }
                if (reviewText) {
                    addReview(reviewText, nameText, selectedRating);
                    nameInput.value = '';
                    textarea.value = '';
                    selectedRating = 0;
                    document.querySelectorAll('#review-modal .star').forEach(s => {
                        s.classList.add('text-gray-400');
                        s.classList.remove('text-yellow-400');
                    });
                    document.getElementById('review-modal').classList.remove('show');
                    alert('Terima kasih atas review Anda!');
                } else {
                    alert('Tolong isi review terlebih dahulu.');
                }
            });
            
            // Rating stars
            document.querySelectorAll('#review-modal .star').forEach(star => {
                star.addEventListener('click', () => {
                    selectedRating = parseInt(star.dataset.rating);
                    document.querySelectorAll('#review-modal .star').forEach(s => {
                        if (parseInt(s.dataset.rating) <= selectedRating) {
                            s.classList.add('text-yellow-400');
                            s.classList.remove('text-gray-400');
                        } else {
                            s.classList.add('text-gray-400');
                            s.classList.remove('text-yellow-400');
                        }
                    });
                });
            });
            safeAddEventListener('close-review-button', 'click', () => {
                document.getElementById('review-modal').classList.remove('show');
            });
            safeAddEventListener('tutorial-link', 'click', (e) => {
                e.preventDefault();
                console.log('Tutorial link clicked');
                const modal = document.getElementById('tutorial-modal');
                if (modal) {
                    modal.classList.add('show');
                    console.log('Tutorial modal shown');
                } else {
                    console.error('Tutorial modal not found');
                }
            });
            safeAddEventListener('close-tutorial', 'click', () => {
                document.getElementById('tutorial-modal').classList.remove('show');
            });
            safeAddEventListener('close-tutorial-button', 'click', () => {
                document.getElementById('tutorial-modal').classList.remove('show');
            });

            // Mobile menu toggle
            safeAddEventListener('mobile-menu-button', 'click', () => {
                const mobileMenu = document.getElementById('mobile-menu');
                mobileMenu.classList.toggle('hidden');
            });

            // Mobile menu links
            safeAddEventListener('about-link-mobile', 'click', (e) => {
                e.preventDefault();
                document.getElementById('mobile-menu').classList.add('hidden');
                const modal = document.getElementById('about-modal');
                if (modal) {
                    modal.classList.add('show');
                }
            });
            safeAddEventListener('review-link-mobile', 'click', (e) => {
                e.preventDefault();
                document.getElementById('mobile-menu').classList.add('hidden');
                const modal = document.getElementById('review-modal');
                if (modal) {
                    modal.classList.add('show');
                }
            });
            safeAddEventListener('tutorial-link-mobile', 'click', (e) => {
                e.preventDefault();
                document.getElementById('mobile-menu').classList.add('hidden');
                const modal = document.getElementById('tutorial-modal');
                if (modal) {
                    modal.classList.add('show');
                }
            });

        }); // Penutup 'DOMContentLoaded'
    </script>

    <!-- Bagian Review dari Pengguna -->
    <div id="reviews-section" class="mt-8 max-w-4xl mx-auto px-4">
        <h2 class="text-2xl font-bold text-white mb-6 text-center">Review dari Pengguna</h2>
        <div class="overflow-hidden max-w-[960px] mx-auto">
            <div id="reviews-container" class="flex gap-6"></div>
        </div>
    </div>

</body>
</html>