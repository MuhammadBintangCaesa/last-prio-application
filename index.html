<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
      <link rel="icon" type="image/png" href="image/prio.back.png">
        <style>
           
            body {
                font-family: 'Inter', sans-serif;
                min-height: 100vh;
                background: radial-gradient(ellipse at bottom, #0d1d31 0%, #0c0d13 100%);
                overflow-y: auto;
                overflow-x: hidden;
                display: flex;
                flex-direction: column;
            }
            .stars {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 120%;
                transform: rotate(-45deg);
            }
            .star {
                --star-color: blue;
                --star-tail-length: 4em;
                --star-tail-height: 2px;
                --star-width: calc(var(--star-tail-length) / 6);
                --fall-duration: 9s;
                --tail-fade-duration: var(--fall-duration);
                position: absolute;
                top: var(--top-offset, 0);
                left: 0;
                width: var(--star-tail-length);
                height: var(--star-tail-height);
                color: var(--star-color);
                background: linear-gradient(45deg, currentColor, transparent);
                border-radius: 50%;
                filter: drop-shadow(0 0 6px currentColor);
                transform: translate3d(104em, 0, 0);
                animation: fall var(--fall-duration) var(--fall-delay, 0s) linear infinite, tail-fade var(--tail-fade-duration) var(--fall-delay, 0s) ease-out infinite;
            }
            .star::before, .star::after {
                position: absolute;
                content: '';
                top: 0;
                left: calc(var(--star-width) / -2);
                width: var(--star-width);
                height: 100%;
                background: linear-gradient(45deg, transparent, currentColor, transparent);
                border-radius: inherit;
                animation: blink 2s linear infinite;
            }
            .star::before { transform: rotate(45deg); }
            .star::after { transform: rotate(-45deg); }
            @keyframes fall {
                to {
                    transform: translate3d(-30em, 0, 0);
                }
            }
            @keyframes tail-fade {
                0%, 50% {
                    width: var(--star-tail-length);
                    opacity: 1;
                }
                70%, 80% {
                    width: 0;
                    opacity: 0.4;
                }
                100% {
                    width: 0;
                    opacity: 0;
                }
            }
            @keyframes blink {
                50% {
                    opacity: 0.6;
                }
            }
            star {
                position: absolute;
                top: 0;
                left: 0;
                width: 6em;
                height: 2px;
                color: #fff;
                background: linear-gradient(45deg, currentColor, transparent);
                border-radius: 50%;
                filter: drop-shadow(0 0 6px currentColor);
                transform: translate3d(104em, 0, 0);
                animation: fall 9s linear infinite, tail-fade 9s ease-out infinite;
            }
            .star::before, .star::after {
                position: absolute;
                content: '';
                top: 0;
                left: calc(6em / -12);
                width: 1em;
                height: 100%;
                background: linear-gradient(45deg, transparent, currentColor, transparent);
                border-radius: inherit;
                animation: blink 2s linear infinite;
            }
            .star::before { transform: rotate(45deg); }
            .star::after { transform: rotate(-45deg); }
            @keyframes fall {
                to { transform: translate3d(-30em, 0, 0); }
            }
            @keyframes tail-fade {
                0%, 50% { width: 6em; opacity: 1; }
                70%, 80% { width: 0; opacity: 0.4; }
                100% { width: 0; opacity: 0; }
            }
            @keyframes blink {
                50% { opacity: 0.6; }
            }
            #main-content {
                background: rgba(255,255,255,0.06);
                border-radius: 16px;
                border: 1px solid rgba(255,255,255,0.07);
                padding-top: 2rem;
                padding-bottom: 2rem;
            }
        </style>
</head>
<body class="text-slate-800">
                <div class="stars">
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
  <div class="star"></div>
</div>
        <!-- NAVBAR -->
        <nav class="w-full bg-white/20 backdrop-blur-md border-b border-white/20 static">
            <div class="max-w-4xl mx-auto flex flex-row items-center justify-between px-4 py-3">
                <div class="flex items-center gap-2">
                    <img src="image/prio.back-removebg-preview.png" alt="Logo Prio" class="w-10 h-10 rounded-full bg-white/60 p-1">
                    <span class="text-xl font-bold text-white tracking-widest">PRIO</span>
                </div>
                <div class="flex-1 flex justify-end items-center gap-2">
                    <button id="about-us-btn" class="px-3 py-1.5 rounded-lg text-sm bg-white/30 text-blue-900 hover:bg-white/50 transition">Tentang Aplikasi</button>
                    <button id="review-app-btn" class="px-3 py-1.5 rounded-lg text-sm bg-white/30 text-blue-900 hover:bg-white/50 transition">Review Aplikasi</button>
                </div>
            </div>
                <!-- header -->
        </nav>
        <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <header id= "header" class="mb-8 text-center text-white space-800">
            <h1 class="js-split text-4xl md:text-5xl font-extrabold tracking-widest mb-2"
                style="line-height:1;">
                Selamat Datang di <span class="text-blue-300">Prio</span>
            </h1>
            <p class="text-white-400 mb-2">Asisten cerdas untuk memprioritaskan tugas kuliah Anda.</p>
            <img src="image/prio.back-removebg-preview.png" 
             alt="gambar logo prio" 
             class="mx-auto my-4 w-32 h-32">
        </header>
        
        <!-- Elemen UI untuk Login dan Logout -->
       <!-- LOGIN VIEW -->
        <div id="login-view" class="flex items-center justify-center py-12">
            <div class="bg-white/40 backdrop-blur-lg border border-white/20 rounded-2xl p-8 shadow-lg w-full sm:w-[420px] text-center transition-all duration-500 hover:scale-[1.02]">
            <h2 class="text-2xl font-bold text-white mb-2">
            Selamat Datang di <span class="text-blue-300">Prio</span>
            </h2>
            <p class="text-slate-300 mb-6 text-sm">
            Kelola & prioritaskan tugasmu dengan cerdas
            </p>
            <div class="flex flex-col gap-4">
            <button id="login-button" class="bg-white text-slate-700 font-semibold py-2 px-6 rounded-lg shadow-md hover:shadow-lg hover:bg-slate-100 transition-all flex items-center justify-center gap-2 w-full">
                <img src="https://www.svgrepo.com/show/355037/google.svg" alt="Google" class="w-5 h-5">
                Login dengan Google
            </button>
            <button id="guest-login-button" class="bg-gradient-to-r from-blue-600 to-indigo-500 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:from-blue-700 hover:to-indigo-600 transition-all w-full">
                Masuk sebagai Tamu
            </button>
            </div>
            <p class="text-xs text-slate-400 mt-6">
            Dengan login, Anda menyetujui
            <button id="privacy-btn" class="text-blue-300 hover:underline">kebijakan privasi</button>.
            </p>
        </div>
        </div>

        <div id="about-us-modal" class="hidden fixed inset-0 bg-black/40 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl shadow-xl w-[90%] max-w-[400px] p-6 text-slate-700 relative flex flex-col items-center justify-center max-h-[50vh] overflow-y-auto">
                        <h3 class="text-xl font-bold mb-2 text-center">Tentang Aplikasi</h3>
                        <p class="mb-2 text-sm text-slate-600">Aplikasi <b>Prio</b> dibuat oleh mahasiswa Universitas Gunadarma sebagai mini project untuk membantu mahasiswa memprioritaskan tugas kuliah secara cerdas dan efisien.</p>
                        <ul class="list-disc list-inside text-sm text-slate-600 mb-4">
                            <li>Pengembang: <b>Kelompok Sains Data</b></li>
                            <li>Kampus: <b>Universitas Gunadarma</b></li> </ul>
                            <div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div><div class="star"></div>
                <p class="text-sm text-slate-300 mb-3">Login sebagai <strong id="user-email" class="text-white"></strong></p>
                <button id="logout-button" class="bg-red-500 text-white font-semibold py-1.5 px-5 text-sm rounded-lg hover:bg-red-600 transition-all shadow-md">Logout</button>
            </div>
        </div>

        <!-- Konten Utama -->
    <main id="main-content" class="hidden min-h-screen bg-transparent py-10 px-4 max-w-6xl mx-auto">
                        <!-- GREETING & RINGKASAN -->
                        <div class="bg-gradient-to-r from-blue-100/80 to-green-100/80 p-6 rounded-xl shadow-md mb-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-blue-700 mb-1">Halo, <span id="main-greeting-user" class="text-indigo-600">User</span>! ðŸ‘‹</h2>
                                <p class="text-slate-600">Selamat datang di Prio. Prioritaskan tugasmu dan capai targetmu!</p>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="text-lg font-semibold text-green-700">Total Tugas: <span id="main-task-count" class="font-bold">0</span></span>
                            </div>
                        </div>
            <div class="bg-white/80 p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-2xl font-bold mb-4 text-blue-700 flex items-center gap-2"><svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>Tambah Tugas</h2>
                <!-- Form input -->
                <form id="task-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 1">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 2">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 3">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 4">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 5">
                    <input type="text" class="task-name w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh â†’ Tugas 6">
                    <div><label for="task-urgency" class="block text-sm font-medium text-slate-700 mb-1">Urgensi (1-5)</label><input type="range" id="task-urgency" min="1" max="5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"><span id="urgency-value" class="text-sm text-slate-500">3 (Sedang)</span></div>
                    <div><label for="task-importance" class="block text-sm font-medium text-slate-700 mb-1">Pentingnya (1-5)</label><input type="range" id="task-importance" min="1" max="5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer"><span id="importance-value" class="text-sm text-slate-500">3 (Cukup Penting)</span></div>
                    <div class="md:col-span-2"><label for="task-deadline" class="block text-sm font-medium text-slate-700 mb-1">Deadline Tugas (Tanggal)</label><input type="date" id="task-deadline" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div class="md:col-span-2"><label for="task-time" class="block text-sm font-medium text-slate-700 mb-1">Estimasi Waktu (Jam)</label><input type="number" id="task-time" min="0.5" step="0.5" value="1" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div>
                    <div class="md:col-span-2"><button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">Prioritaskan & Tambah</button></div>
                </form>
            </div>

            <div>
                <!-- Daftar Tugas & Tombol Download Baru -->
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-blue-700">Daftar Tugas Anda</h2>
                    <!-- Tombol Download HANYA UNTUK GOOGLE USER -->
                    <button id="download-my-data-button" class="hidden bg-green-600 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        Download Dataku
                    </button>
                </div>

                <!-- Panel Admin DIHAPUS -->

                <div id="task-list" class="space-y-4">
                                        <div id="empty-task-illustration" class="hidden flex flex-col items-center justify-center py-8">
                                            <img src="https://cdn.jsdelivr.net/gh/edent/SuperTinyIcons/images/svg/clipboard.svg" alt="No tasks" class="w-24 h-24 mb-4 opacity-60">
                                            <p class="text-slate-400 text-lg">Belum ada tugas. Yuk, tambah tugas pertamamu!</p>
                                        </div>
                    <p id="loading-tasks" class="text-slate-300 text-center">Memuat tugas...</p>
                </div>
            </div>
        </main>
    </div>
</body>
</html>


    <!-- Firebase SDK -->
    <script type="module">

                // Dropdown menu logic
                document.addEventListener('DOMContentLoaded', () => {
                    const navbarAuth = document.getElementById('navbar-auth');
                    const dropdown = document.getElementById('navbar-dropdown');
                    if (navbarAuth) {
                        navbarAuth.addEventListener('click', (e) => {
                            if (dropdown) dropdown.classList.toggle('hidden');
                            e.stopPropagation();
                        });
                    }
                    document.body.addEventListener('click', () => {
                        if (dropdown) dropdown.classList.add('hidden');
                    });
                });

                // About Us modal logic
                document.addEventListener('DOMContentLoaded', () => {
                    const aboutBtn = document.getElementById('about-us-btn');
                    const aboutModal = document.getElementById('about-us-modal');
                    const closeAbout = document.getElementById('close-about-us');
                    if (aboutBtn && aboutModal && closeAbout) {
                        aboutBtn.onclick = (e) => { aboutModal.classList.remove('hidden'); e.stopPropagation(); };
                        closeAbout.onclick = () => aboutModal.classList.add('hidden');
                    }
                });

                // Review modal logic
                document.addEventListener('DOMContentLoaded', () => {
                    const reviewBtn = document.getElementById('review-app-btn');
                    const reviewModal = document.getElementById('review-modal');
                    const closeReview = document.getElementById('close-review');
                    const reviewForm = document.getElementById('review-form');
                    const reviewText = document.getElementById('review-text');
                    const reviewList = document.getElementById('review-list');
                    let reviews = [];
                    if (reviewBtn && reviewModal && closeReview && reviewForm && reviewText && reviewList) {
                        reviewBtn.onclick = (e) => { reviewModal.classList.remove('hidden'); e.stopPropagation(); };
                        closeReview.onclick = () => reviewModal.classList.add('hidden');
                        reviewForm.onsubmit = (ev) => {
                            ev.preventDefault();
                            const val = reviewText.value.trim();
                            if (val) {
                                reviews.unshift(val);
                                reviewText.value = '';
                                renderReviews();
                            }
                        };
                        function renderReviews() {
                            reviewList.innerHTML = reviews.length === 0 ? '<p class="text-slate-400 text-sm text-center">Belum ada review.</p>' : reviews.map(r => `<div class='bg-slate-100 rounded-lg px-3 py-2 text-slate-700 text-sm'>${r}</div>`).join('');
                        }
                        renderReviews();
                    }
                });

        // Update greeting user dan jumlah tugas di main page
        function updateMainGreeting(user) {
            const el = document.getElementById('main-greeting-user');
            if (el) {
                el.textContent = user?.email ? user.email.split('@')[0] : 'Tamu';
            }
        }
        function updateMainTaskCount(count) {
            const el = document.getElementById('main-task-count');
            if (el) el.textContent = count;
        }
        function showEmptyTaskIllustration(show) {
            const illu = document.getElementById('empty-task-illustration');
            if (illu) illu.classList.toggle('hidden', !show);
        }

                        // Navbar login/logout dinamis
                        function updateNavbarAuth(user) {
                                const navbarAuth = document.getElementById('navbar-auth');
                                if (!navbarAuth) return;
                                navbarAuth.innerHTML = '';
                                if (user) {
                                        navbarAuth.innerHTML = `<span class="text-white text-sm mr-2">${user.email || 'Tamu'}</span><button id="navbar-logout" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">Logout</button>`;
                                        setTimeout(() => {
                                            const btn = document.getElementById('navbar-logout');
                                            if (btn) btn.onclick = () => signOut(auth);
                                        }, 100);
                                } else {
                                        navbarAuth.innerHTML = `<button id="navbar-login" class="bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700 text-sm">Login</button>`;
                                        setTimeout(() => {
                                            const btn = document.getElementById('navbar-login');
                                            if (btn) btn.onclick = () => document.getElementById('login-button').click();
                                        }, 100);
                                }
                        }
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, updateDoc, deleteDoc, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Fungsi utilitas aman ---
        function safeAddEventListener(elementId, event, handler) {
             try {
                const element = document.getElementById(elementId);
                if (element) {
                    element.addEventListener(event, handler);
                } else {
                    console.warn(`[WARN] Elemen dengan ID "${elementId}" tidak ditemukan saat mencoba menambah listener.`);
                }
            } catch(e) {
                 console.error(`[ERROR] Gagal menambah listener ke #${elementId}:`, e);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log("[DEBUG] Halaman HTML selesai dimuat. Memulai skrip.");

            // Konfigurasi Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyC4WwUhxG5XROTr5lSHvhDS4zj2Lqmw1U0",
                authDomain: "asisten-tugas-pribadi.firebaseapp.com",
                projectId: "asisten-tugas-pribadi",
                storageBucket: "asisten-tugas-pribadi.appspot.com",
                messagingSenderId: "994319187177",
                appId: "1:994319187177:web:58ebbc1fce8645eabd4478"
            };

            let db, auth, userId, unsubscribeTasks;
            const appId = 'asisten-tugas-pribadi';
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("[DEBUG] Firebase diinisialisasi.");

            // --- Elemen UI ---
            const loginView = document.getElementById('login-view');
            const userView = document.getElementById('user-view');
            const mainContent = document.getElementById('main-content');
            const userEmailSpan = document.getElementById('user-email');
            const taskForm = document.getElementById('task-form');
            const taskListDiv = document.getElementById('task-list');
            const downloadMyDataButton = document.getElementById('download-my-data-button'); // Tombol download baru
            
            // --- Fungsi Admin Dihapus ---
            // const loadUserListForAdmin = ... (DIHAPUS)
            // const checkAdminStatus = ... (DIHAPUS)

            // --- onAuthStateChanged (Disederhanakan) ---
            onAuthStateChanged(auth, async (user) => {
                                updateMainGreeting(user);
                updateNavbarAuth(user);
                // Sembunyikan semua elemen dinamis di awal
                mainContent.classList.add('hidden');
                userView.classList.add('hidden');
                loginView.classList.add('hidden');
                downloadMyDataButton.classList.add('hidden'); 

                if (user) {
                    userId = user.uid;
                    userEmailSpan.innerHTML = user.isAnonymous ? `Tamu <span class="font-normal text-slate-400 text-xs">(${user.uid.substring(0, 6)}...)</span>` : user.email;
                    
                    userView.classList.remove('hidden');
                    mainContent.classList.remove('hidden');

                    // Tampilkan tombol download HANYA jika bukan tamu
                    if (!user.isAnonymous) {
                        downloadMyDataButton.classList.remove('hidden');
                    }

                    listenToTasks();
                } else {
                    userId = null;
                    loginView.classList.remove('hidden'); // Tampilkan view login
                    if (unsubscribeTasks) unsubscribeTasks();
                    renderTasks([]);
                }
            });

            // --- Path Collection ---
            const getTasksCollectionRef = (targetUserId) => {
                const idToUse = targetUserId || userId;
                if (!idToUse) {
                    console.error("[DEBUG] GAGAL: getTasksCollectionRef dipanggil tetapi ID pengguna adalah null!");
                    return null;
                }
                return collection(db, `artifacts/${appId}/users/${idToUse}/tasks`);
            }

            // --- FUNGSI ADD NEW TASK (YANG HILANG) ---
            const addNewTask = async (taskData) => {
                 if (!userId) {
                     alert("Error: Anda tidak terautentikasi.");
                     return false;
                 }
                 try {
                     const urgency = Number(taskData.urgency);
                     const importance = Number(taskData.importance); // Menggunakan importance
                     const time = Number(taskData.time);

                     if (isNaN(urgency) || isNaN(importance) || isNaN(time)) {
                         throw new Error("Data input tidak valid. Gagal menghitung skor.");
                     }
                     
                     const priorityScore = parseFloat(((urgency * 3.5) + (importance * 2.5) - (time * 0.5)).toFixed(2));
                     
                     const fullTaskData = {
                         name: taskData.name,
                         urgency: urgency,
                         importance: importance, // Menggunakan importance
                         time: time,
                         deadline: taskData.deadline, // Menambahkan deadline
                         priorityScore: priorityScore,
                         status: 'pending',
                         createdAt: serverTimestamp()
                     };

                     const collectionRef = getTasksCollectionRef(userId);
                     if (!collectionRef) throw new Error("Referensi koleksi tidak valid (userId null).");
                     
                     await addDoc(collectionRef, fullTaskData);
                     return true;
                 } catch (error) {
                     console.error("GAGAL MENAMBAHKAN TUGAS:", error);
                     alert("GAGAL: " + error.message);
                     return false;
                 }
             };

taskForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!userId) {
        alert("Error: Anda tidak terautentikasi.");
        return;
    }

    const taskInputs = document.querySelectorAll('.task-name');
    const urgency = parseInt(document.getElementById('task-urgency').value);
    const importance = parseInt(document.getElementById('task-importance').value);
    const time = parseFloat(document.getElementById('task-time').value);
    const deadlineValue = document.getElementById('task-deadline').value;

    const deadlineDate = deadlineValue ? new Date(deadlineValue) : null;
    if (deadlineDate) deadlineDate.setHours(23, 59, 59);

    let hasTask = false;

    // Loop semua input nama tugas
    for (const input of taskInputs) {
        const name = input.value.trim();
        if (name === "") continue;

        hasTask = true;

        const taskData = {
            name,
            urgency,
            importance,
            time,
            deadline: deadlineDate || null
        };

        await addNewTask(taskData);
    }

    if (!hasTask) {
        alert("Minimal isi 1 tugas.");
        return;
    }

    // Reset form
    e.target.reset();
    document.getElementById('urgency-value').textContent = '3 (Sedang)';
    document.getElementById('importance-value').textContent = '3 (Cukup Penting)';
});


            // --- Login/Logout ---
            const signInWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(err => console.error(err));
            const signInAsGuest = () => signInAnonymously(auth).catch(err => console.error(err));
            const doSignOut = () => signOut(auth).catch(err => console.error(err));
            safeAddEventListener('login-button', 'click', signInWithGoogle);
            safeAddEventListener('guest-login-button', 'click', signInAsGuest);
            safeAddEventListener('logout-button', 'click', doSignOut);

            // --- FUNGSI EKSPOR CSV FIX (NON-ADMIN) ---
const exportMyDataAsCsv = async () => {
    if (!userId) {
        alert("Silakan login terlebih dahulu.");
        return;
    }

    try {
        const tasksCollectionRef = getTasksCollectionRef(userId);
        const tasksSnapshot = await getDocs(query(tasksCollectionRef));

        const tasks = [];
        tasksSnapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));

        if (tasks.length === 0) {
            alert("Anda tidak memiliki data tugas.");
            return;
        }

        // --- ðŸ”¥ SORT BIAR SESUAI UI (priorityScore terbesar â†’ terkecil)
        tasks.sort((a, b) => (b.priorityScore ?? 0) - (a.priorityScore ?? 0));

        // --- Fungsi escape agar koma tidak rusak CSV
        const escapeCSV = value => {
            if (value == null) return "";
            const str = String(value);
            return (str.includes(",") || str.includes('"')) 
                ? `"${str.replace(/"/g, '""')}"`
                : str;
        };

        // --- Header CSV
        const headers = [
            "ID Tugas",
            "Nama Tugas",
            "Urgensi",
            "Pentingnya",
            "Estimasi Waktu",
            "Deadline",
            "Skor Prioritas",
            "Status",
            "Dibuat"
        ];

        // --- Buat baris data
        const rows = tasks.map(task => {
            const deadline = task.deadline
                ? new Date(task.deadline.seconds * 1000).toLocaleDateString("id-ID")
                : "N/A";

            const createdAt = task.createdAt
                ? new Date(task.createdAt.seconds * 1000).toLocaleString("id-ID")
                : "N/A";

            return [
                escapeCSV(task.id),
                escapeCSV(task.name),
                escapeCSV(task.urgency),
                escapeCSV(task.importance),
                escapeCSV(task.time),
                escapeCSV(deadline),
                escapeCSV(task.priorityScore),
                escapeCSV(task.status),
                escapeCSV(createdAt)
            ].join(",");
        });

        // Gabungkan CSV
        const csvContent = [headers.join(','), ...rows].join('\n');
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });

        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);

        const date = new Date().toISOString().slice(0, 10);
        link.download = `prio_data_saya_${date}.csv`;

        link.click();
        URL.revokeObjectURL(link.href);

    } catch (error) {
        console.error("[DEBUG] CSV Export Error:", error);
        alert("Gagal mengunduh data.");
    }
};
            safeAddEventListener('download-my-data-button', 'click', exportMyDataAsCsv);
            // --- Baca & Tampilkan Data ---
            function listenToTasks() {
                if (!userId) return;
                if (unsubscribeTasks) unsubscribeTasks();
                const q = query(getTasksCollectionRef(userId));
                if (!q) return;
                unsubscribeTasks = onSnapshot(q, (snapshot) => {
                    let tasks = [];
                    snapshot.forEach(doc => tasks.push({ id: doc.id, ...doc.data() }));
                    tasks.sort((a, b) => (b.priorityScore ?? -Infinity) - (a.priorityScore ?? -Infinity));
                    renderTasks(tasks);
                }, (error) => {
                    console.error("[DEBUG] Gagal mendengarkan data (listenToTasks):", error);
                });
            }

            function renderTasks(tasks) {
                const loadingP = document.getElementById('loading-tasks');
                if(loadingP) loadingP.style.display = 'none';

                updateMainTaskCount(tasks ? tasks.length : 0);
                if (!tasks || tasks.length === 0) {
                    showEmptyTaskIllustration(true);
                    taskListDiv.innerHTML = '';
                    return;
                }
                showEmptyTaskIllustration(false);
                taskListDiv.innerHTML = tasks.map(task => {
                    const priorityScoreNum = Number(task.priorityScore);
                    const priorityText = isNaN(priorityScoreNum) ? 'N/A' :
                                     priorityScoreNum > 15 ? 'Tinggi' :
                                     priorityScoreNum > 8 ? 'Sedang' : 'Rendah';
                    const priorityClass = isNaN(priorityScoreNum) ? 'priority-low' :
                                        priorityText === 'Tinggi' ? 'priority-high' :
                                        priorityText === 'Sedang' ? 'priority-medium' : 'priority-low';
                    const scoreDisplay = isNaN(priorityScoreNum) ? 'NaN' : priorityScoreNum.toFixed(1);
                    
                    // Format deadline untuk ditampilkan
                const deadlineText = task.deadline ? new Date(task.deadline).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'}) : 'Tidak Ditentukan';

                    return `
                    <div class="task-card bg-white p-4 rounded-xl shadow-md flex items-start gap-4 ${task.status === 'completed' ? 'opacity-60' : ''}">
                        <input type="checkbox" onchange="window.toggleTaskStatus('${task.id}', '${task.status}')" class="mt-1.5 h-5 w-5 rounded" ${task.status === 'completed' ? 'checked' : ''}>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                                <p class="font-semibold text-lg ${task.status === 'completed' ? 'line-through' : ''}">${task.name}</p>
                                <span class="priority-badge ${priorityClass}">${priorityText} (${scoreDisplay})</span>
                            </div>
                            <div class="text-sm text-slate-500 mt-2 flex flex-col sm:flex-row sm:gap-4">
                                <span>Urgensi: <strong>${task.urgency}</strong></span>
                                <span>Pentingnya: <strong>${task.importance}</strong></span> <!-- Menggunakan importance -->
                                <span>Waktu: <strong>${task.time} jam</strong></span>
                            </div>
                             <div class="text-sm text-slate-700 mt-2 font-medium">
                                <span>Deadline: <strong>${deadlineText}</strong></span>
                            </div>
                        </div>
                        <button onclick="window.deleteTask('${task.id}')" class="text-slate-400 hover:text-red-500 p-1">
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>`;
                }).join('');
            }

            // Slider
            const urgencySlider = document.getElementById('task-urgency');
            const importanceSlider = document.getElementById('task-importance');
            const urgencyValue = document.getElementById('urgency-value');
            const importanceValue = document.getElementById('importance-value');
            const urgencyLabels = { 1: 'Sangat Rendah', 2: 'Rendah', 3: 'Sedang', 4: 'Mendesak', 5: 'Sangat Mendesak' };
            const importanceLabels = { 1: 'Tidak Penting', 2: 'Kurang Penting', 3: 'Cukup Penting', 4: 'Penting', 5: 'Sangat Penting' };
            urgencySlider.addEventListener('input', () => { urgencyValue.textContent = `${urgencySlider.value} (${urgencyLabels[urgencySlider.value]})`; });
            importanceSlider.addEventListener('input', () => { importanceValue.textContent = `${importanceSlider.value} (${importanceLabels[importanceSlider.value]})`; });

            // --- Fungsi Global (onclick) ---
            window.toggleTaskStatus = async (taskId, currentStatus) => {
                if (!userId) return;
                const newStatus = currentStatus === 'pending' ? 'completed' : 'pending';
                const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);
                await updateDoc(taskDocRef, { status: newStatus });
            };

            window.deleteTask = async (taskId) => {
                if (!userId) return;
                if (confirm('Yakin ingin menghapus tugas ini?')) {
                    const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);
                    await deleteDoc(taskDocRef);
                }
            };

            // --- Logika Modal Privasi & Gradient (Dipindah ke dalam) ---
            safeAddEventListener("privacy-btn", "click", () => {
                const privacyModal = document.getElementById("privacy-modal");
                if (privacyModal) privacyModal.classList.remove("hidden");
            });

            safeAddEventListener("close-privacy", "click", () => {
                const privacyModal = document.getElementById("privacy-modal");
                if (privacyModal) privacyModal.classList.add("hidden");
            });

            safeAddEventListener("privacy-modal", "click", (e) => {
                if (e.target.id === "privacy-modal") {
                    e.target.classList.add("hidden");
                }
            });
            
            const gradientEl = document.querySelector('.gradient');
            if (gradientEl) {
                let targetX = window.innerWidth / 2;
                let targetY = window.innerHeight / 2;
                let currentX = targetX;
                let currentY = targetY;
                document.addEventListener('mousemove', (e) => {
                    targetX = e.clientX;
                    targetY = e.clientY;
                });
                function animate() {
                    currentX += (targetX - currentX) * 0.1;
                    currentY += (targetY - currentY) * 0.1;
                    gradientEl.style.left = `${(currentX / window.innerWidth) * 100}%`;
                    gradientEl.style.top = `${(currentY / window.innerHeight) * 100}%`;
                    requestAnimationFrame(animate);
                }
                animate();
            } else {
                console.warn("Elemen .gradient tidak ditemukan di halaman.");
            }

            document.getElementById("theme-toggle").addEventListener("click", () => {
             document.documentElement.classList.toggle("dark");

            // simpan preferensi user
            if (document.documentElement.classList.contains("dark")) {
                localStorage.setItem("theme", "dark");
            } else {
                localStorage.setItem("theme", "light");
            }
        });

            // load preferensi saat halaman buka
            if (localStorage.getItem("theme") === "dark") {
                document.documentElement.classList.add("dark");
            }

        }); // Penutup 'DOMContentLoaded'
    </script>
</body>
</html>